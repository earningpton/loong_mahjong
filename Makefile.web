# Mahjong Loong - Web Build Makefile
# Compiles the game to WebAssembly for browser play

# Emscripten compiler
CC = emcc

# Project name
PROJECT_NAME = mahjong_loong

# Source files
SOURCES = main.cpp

# Compiler flags for web build
CFLAGS = -std=c++17 -Wall -Wno-missing-braces -O2

# Emscripten-specific flags
EMFLAGS = -s USE_GLFW=3 \
          -s ASYNCIFY \
          -s TOTAL_MEMORY=67108864 \
          -s FORCE_FILESYSTEM=1 \
          -s ASSERTIONS=1 \
          --shell-file web_shell.html \
          --preload-file Graphics \
          --preload-file Sounds

# Raylib for web (using emscripten port)
RAYLIB_FLAGS = -s USE_GLFW=3 -s LEGACY_GL_EMULATION=1

# Output files
OUTPUT_JS = $(PROJECT_NAME).js
OUTPUT_WASM = $(PROJECT_NAME).wasm
OUTPUT_HTML = $(PROJECT_NAME).html
OUTPUT_DATA = $(PROJECT_NAME).data

# Default target
all: web

# Web build target
web: $(OUTPUT_JS)

$(OUTPUT_JS): $(SOURCES)
	@echo "üêâ Building Mahjong Loong for Web..."
	@echo "üì¶ Compiling C++ to WebAssembly..."
	$(CC) $(SOURCES) $(CFLAGS) $(EMFLAGS) $(RAYLIB_FLAGS) -o $(OUTPUT_JS)
	@echo "‚úÖ Web build complete!"
	@echo "üåê Files generated:"
	@echo "   - $(OUTPUT_JS) (JavaScript loader)"
	@echo "   - $(OUTPUT_WASM) (WebAssembly binary)"
	@echo "   - $(OUTPUT_DATA) (Game assets)"
	@echo ""
	@echo "üöÄ To test locally:"
	@echo "   python -m http.server 8000"
	@echo "   Then open: http://localhost:8000"

# Clean build files
clean:
	@echo "üßπ Cleaning web build files..."
	rm -f $(OUTPUT_JS) $(OUTPUT_WASM) $(OUTPUT_HTML) $(OUTPUT_DATA)
	@echo "‚úÖ Clean complete!"

# Install Emscripten (helper target)
install-emscripten:
	@echo "üì¶ Installing Emscripten..."
	@echo "Please follow the official guide at:"
	@echo "https://emscripten.org/docs/getting_started/downloads.html"
	@echo ""
	@echo "Quick install (Linux/Mac):"
	@echo "git clone https://github.com/emscripten-core/emsdk.git"
	@echo "cd emsdk"
	@echo "./emsdk install latest"
	@echo "./emsdk activate latest"
	@echo "source ./emsdk_env.sh"

# Test server (requires Python)
serve:
	@echo "üåê Starting local test server..."
	@echo "Open your browser to: http://localhost:8000"
	@echo "Press Ctrl+C to stop the server"
	python -m http.server 8000

# Help target
help:
	@echo "üêâ Mahjong Loong - Web Build Help"
	@echo ""
	@echo "Available targets:"
	@echo "  web                 - Build the web version"
	@echo "  clean              - Remove build files"
	@echo "  serve              - Start local test server"
	@echo "  install-emscripten - Show Emscripten install instructions"
	@echo "  help               - Show this help"
	@echo ""
	@echo "Prerequisites:"
	@echo "  - Emscripten SDK installed and activated"
	@echo "  - Python (for local testing)"
	@echo ""
	@echo "Build process:"
	@echo "  1. make web"
	@echo "  2. make serve"
	@echo "  3. Open http://localhost:8000 in browser"

.PHONY: all web clean install-emscripten serve help
