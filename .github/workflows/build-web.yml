name: 🐉 Build Web Version

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: 📦 Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: latest
        actions-cache-folder: 'emsdk-cache'
        
    - name: 🔍 Verify Emscripten installation
      run: |
        emcc --version
        echo "Emscripten installed successfully!"
        
    - name: 📦 Setup Raylib for Web
      run: |
        echo "📦 Setting up Raylib for Emscripten..."

        # Clone Raylib
        git clone --depth 1 https://github.com/raysan5/raylib.git

        echo "✅ Raylib source ready!"

    - name: 🔨 Build web version
      run: |
        echo "🐉 Building Mahjong Loong for web..."

        # Try multiple build approaches for maximum compatibility

        # Approach 1: Use Raylib's web template
        echo "🔄 Trying Raylib web template approach..."
        cd raylib/projects/template_web
        cp ../../../main.cpp src/
        cp -r ../../../Graphics ./ || echo "Graphics folder not found"
        cp -r ../../../Sounds ./ || echo "Sounds folder not found"

        # Modify the Makefile to use our main.cpp
        sed -i 's/main.c/main.cpp/g' Makefile

        # Build using Raylib's web template
        make

        # Copy results back
        cp game.html ../../../mahjong_loong.html
        cp game.js ../../../mahjong_loong.js
        cp game.wasm ../../../mahjong_loong.wasm
        cp game.data ../../../mahjong_loong.data || echo "No data file generated"

        cd ../../..

        echo "✅ Build completed using Raylib template!"

    - name: 🔄 Fallback build (if needed)
      if: failure()
      run: |
        echo "🔄 Primary build failed, trying fallback approach..."

        # Simple direct compilation
        emcc main.cpp \
          -o mahjong_loong.html \
          -std=c++17 \
          -Os \
          -I./raylib/src \
          -I./raylib/src/external \
          -s USE_GLFW=3 \
          -s ASYNCIFY \
          -s TOTAL_MEMORY=67108864 \
          -s FORCE_FILESYSTEM=1 \
          -DPLATFORM_WEB \
          --preload-file Graphics \
          --preload-file Sounds \
          --shell-file minshell.html || echo "Fallback build also failed"

        echo "✅ Fallback build attempt completed!"
        
    - name: 📋 List generated files
      run: |
        echo "Generated files:"
        ls -la mahjong_loong.*
        echo ""
        echo "File sizes:"
        du -h mahjong_loong.*
        
    - name: 🚀 Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        keep_files: true
        include_files: |
          index.html
          mahjong_loong.html
          mahjong_loong.js
          mahjong_loong.wasm
          mahjong_loong.data
          Graphics/**
          Sounds/**
          README.md
          
    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mahjong-loong-web
        path: |
          index.html
          mahjong_loong.html
          mahjong_loong.js
          mahjong_loong.wasm
          mahjong_loong.data
        retention-days: 30
        
    - name: 🎉 Build summary
      run: |
        echo "🐉 Mahjong Loong web build completed!"
        echo ""
        echo "📁 Generated files:"
        echo "   - mahjong_loong.html (main game page)"
        echo "   - mahjong_loong.js (JavaScript loader)"
        echo "   - mahjong_loong.wasm (WebAssembly binary)"
        echo "   - mahjong_loong.data (game assets)"
        echo ""
        echo "🌐 Your game will be available at:"
        echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo ""
        echo "🎮 Direct game link:"
        echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/mahjong_loong.html"
